name: ShuDL Test Suite

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        # Run tests daily at 2 AM UTC
        - cron: "0 2 * * *"

env:
    DOCKER_COMPOSE_FILE: docker/docker-compose.yml

jobs:
    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Start services
              run: |
                  cd docker
                  docker compose up -d

            - name: Wait for services to be healthy
              run: |
                  timeout 300 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 5; done'
              working-directory: docker

            - name: Run unit tests
              run: |
                  cd tests
                  ./run-tests.sh --category unit --verbose

            - name: Upload test logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: unit-test-logs
                  path: tests/logs/
                  retention-days: 7

            - name: Stop services
              if: always()
              run: |
                  cd docker
                  docker compose down -v

    integration-tests:
        name: Integration Tests
        runs-on: ubuntu-latest
        timeout-minutes: 45
        needs: unit-tests

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Start services
              run: |
                  cd docker
                  docker compose up -d

            - name: Wait for services to be healthy
              run: |
                  timeout 300 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 5; done'
              working-directory: docker

            - name: Run integration tests
              run: |
                  cd tests
                  ./run-tests.sh --category integration --verbose

            - name: Upload test logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: integration-test-logs
                  path: tests/logs/
                  retention-days: 7

            - name: Stop services
              if: always()
              run: |
                  cd docker
                  docker compose down -v

    e2e-tests:
        name: E2E Tests
        runs-on: ubuntu-latest
        timeout-minutes: 60
        needs: integration-tests

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Start services
              run: |
                  cd docker
                  docker compose up -d

            - name: Wait for services to be healthy
              run: |
                  timeout 300 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 5; done'
              working-directory: docker

            - name: Run E2E tests
              run: |
                  cd tests
                  ./run-tests.sh --category e2e --verbose

            - name: Upload test logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: e2e-test-logs
                  path: tests/logs/
                  retention-days: 7

            - name: Stop services
              if: always()
              run: |
                  cd docker
                  docker compose down -v

    full-test-suite:
        name: Full Test Suite
        runs-on: ubuntu-latest
        timeout-minutes: 90
        if: github.event_name == 'schedule' || github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Start services
              run: |
                  cd docker
                  docker compose up -d

            - name: Wait for services to be healthy
              run: |
                  timeout 300 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 5; done'
              working-directory: docker

            - name: Run full test suite
              run: |
                  cd tests
                  ./run-tests.sh --category all --verbose

            - name: Generate test report
              if: always()
              run: |
                  echo "# Test Results" > test-report.md
                  echo "" >> test-report.md
                  cat tests/logs/test-results-*.log >> test-report.md

            - name: Upload test report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: full-test-report
                  path: |
                      test-report.md
                      tests/logs/
                  retention-days: 30

            - name: Stop services
              if: always()
              run: |
                  cd docker
                  docker compose down -v

    test-coverage:
        name: Test Coverage Analysis
        runs-on: ubuntu-latest
        needs: [unit-tests, integration-tests, e2e-tests]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download test logs
              uses: actions/download-artifact@v4
              with:
                  pattern: "*-test-logs"
                  merge-multiple: true
                  path: test-logs

            - name: Calculate coverage
              run: |
                  echo "# Test Coverage Summary" > coverage-report.md
                  echo "" >> coverage-report.md
                  echo "## Components Tested:" >> coverage-report.md
                  echo "- ✅ MinIO (Storage)" >> coverage-report.md
                  echo "- ✅ PostgreSQL (Storage)" >> coverage-report.md
                  echo "- ✅ Nessie (Catalog)" >> coverage-report.md
                  echo "- ✅ Trino (Compute)" >> coverage-report.md
                  echo "- ✅ Spark (Compute - via integration)" >> coverage-report.md
                  echo "- ✅ Iceberg (Table Format)" >> coverage-report.md
                  echo "- ✅ End-to-End Pipeline" >> coverage-report.md

                  # Count test files
                  UNIT_TESTS=$(find tests/unit -name "*.test.sh" | wc -l)
                  INTEGRATION_TESTS=$(find tests/integration -name "*.test.sh" | wc -l)
                  E2E_TESTS=$(find tests/e2e -name "*.test.sh" | wc -l)
                  TOTAL_TESTS=$((UNIT_TESTS + INTEGRATION_TESTS + E2E_TESTS))

                  echo "" >> coverage-report.md
                  echo "## Test Statistics:" >> coverage-report.md
                  echo "- Unit Tests: $UNIT_TESTS" >> coverage-report.md
                  echo "- Integration Tests: $INTEGRATION_TESTS" >> coverage-report.md
                  echo "- E2E Tests: $E2E_TESTS" >> coverage-report.md
                  echo "- **Total Tests: $TOTAL_TESTS**" >> coverage-report.md

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage-report.md
                  retention-days: 30

            - name: Comment PR with coverage
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const coverage = fs.readFileSync('coverage-report.md', 'utf8');
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: coverage
                      });
