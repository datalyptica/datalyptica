name: Build and Push Images

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_build_all:
        description: 'Force build all images regardless of changes'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      id-token: write
      attestations: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Clean up any existing login session
      - name: Clean up Docker credentials
        run: |
          docker logout ghcr.io || true
          rm -f ~/.docker/config.json || true

      - name: Log in to Container Registry
        run: |
          echo "Logging in to ghcr.io..."
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "Using Personal Access Token for authentication"
            echo "${{ secrets.PAT_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          else
            echo "Using GITHUB_TOKEN for authentication"
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          fi



      # Detect changes for each image and shared dependencies
      - name: Detect image changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            # Core shared files that affect all services
            base_changes:
              - 'docker/build.sh'
              - 'docker/push.sh'
              - '.github/workflows/build.yml'
            
            # Service-specific changes (no base image dependencies)
            minio:
              - 'docker/services/minio/**'
              - 'docker/config/minio/**'
            postgresql:
              - 'docker/services/postgresql/**'
              - 'docker/config/postgresql/**'
            patroni:
              - 'docker/services/patroni/**'
              - 'docker/services/postgresql/**'  # Patroni depends on PostgreSQL
              - 'docker/config/postgresql/**'
            nessie:
              - 'docker/services/nessie/**'
              - 'docker/config/nessie/**'
            trino:
              - 'docker/services/trino/**'
              - 'docker/config/trino/**'
            spark:
              - 'docker/services/spark/**'
              - 'docker/config/spark/**'
            
      # Determine build strategy - only force all on workflow_dispatch with force_build_all
      - name: Check if should build all images
        id: build_all
        run: |
          if [[ "${{ github.event.inputs.force_build_all }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.base_changes }}" == "true" ]]; then
            echo "build_all=true" >> $GITHUB_OUTPUT
            echo "Building all images due to core changes or manual trigger"
          else
            echo "build_all=false" >> $GITHUB_OUTPUT
            echo "Building only changed images"
          fi

      # Set flags for what will be built (for use in conditional steps)
      - name: Set build flags
        id: build_flags
        env:
          BUILD_ALL: ${{ steps.build_all.outputs.build_all }}
          CHANGES_OUTPUT: ${{ toJSON(steps.changes.outputs) }}
        run: |
          # Determine what will be built
          if [[ "$BUILD_ALL" == "true" ]]; then
            echo "will_build_minio=true" >> $GITHUB_OUTPUT
            echo "will_build_postgresql=true" >> $GITHUB_OUTPUT
            echo "will_build_patroni=true" >> $GITHUB_OUTPUT
            echo "will_build_nessie=true" >> $GITHUB_OUTPUT
            echo "will_build_trino=true" >> $GITHUB_OUTPUT
            echo "will_build_spark=true" >> $GITHUB_OUTPUT
            echo "Building all images due to core changes or manual trigger"
          else
            # Parse the JSON output to check individual services
            echo "Checking individual service changes..."
            MINIO=$(echo "$CHANGES_OUTPUT" | jq -r '.minio // "false"')
            POSTGRESQL=$(echo "$CHANGES_OUTPUT" | jq -r '.postgresql // "false"')
            PATRONI=$(echo "$CHANGES_OUTPUT" | jq -r '.patroni // "false"')
            NESSIE=$(echo "$CHANGES_OUTPUT" | jq -r '.nessie // "false"')
            TRINO=$(echo "$CHANGES_OUTPUT" | jq -r '.trino // "false"')
            SPARK=$(echo "$CHANGES_OUTPUT" | jq -r '.spark // "false"')
            
            echo "will_build_minio=$MINIO" >> $GITHUB_OUTPUT
            echo "will_build_postgresql=$POSTGRESQL" >> $GITHUB_OUTPUT
            echo "will_build_patroni=$PATRONI" >> $GITHUB_OUTPUT
            echo "will_build_nessie=$NESSIE" >> $GITHUB_OUTPUT
            echo "will_build_trino=$TRINO" >> $GITHUB_OUTPUT
            echo "will_build_spark=$SPARK" >> $GITHUB_OUTPUT
            
            echo "Build flags: minio=$MINIO postgresql=$POSTGRESQL patroni=$PATRONI nessie=$NESSIE trino=$TRINO spark=$SPARK"
          fi

      # MinIO
      - name: Extract MinIO metadata
        id: meta_minio
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/shugur-network/shudl/minio
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=dev-
            type=raw,value=latest,enable={{is_default_branch}}

      # Build and push MinIO image if changed
      - name: Build and push MinIO image
        if: steps.build_flags.outputs.will_build_minio == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/services/minio/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta_minio.outputs.tags }}
          labels: ${{ steps.meta_minio.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # PostgreSQL Standalone
      - name: Extract PostgreSQL metadata
        id: meta_postgresql
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/shugur-network/shudl/postgresql
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=sha,prefix=dev-

      - name: Build and push PostgreSQL image
        if: steps.build_flags.outputs.will_build_postgresql == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/services/postgresql/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta_postgresql.outputs.tags }}
          labels: ${{ steps.meta_postgresql.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Patroni
      - name: Extract Patroni metadata
        id: meta_patroni
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/shugur-network/shudl/patroni
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=dev-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Patroni image
        if: steps.build_flags.outputs.will_build_patroni == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/services/patroni/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta_patroni.outputs.tags }}
          labels: ${{ steps.meta_patroni.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Nessie
      - name: Extract Nessie metadata
        id: meta_nessie
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/shugur-network/shudl/nessie
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=dev-
            type=raw,value=latest,enable={{is_default_branch}}
      - name: Build and push Nessie image
        if: steps.build_flags.outputs.will_build_nessie == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/services/nessie/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta_nessie.outputs.tags }}
          labels: ${{ steps.meta_nessie.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Trino
      - name: Extract Trino metadata
        id: meta_trino
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/shugur-network/shudl/trino
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=dev-
            type=raw,value=latest,enable={{is_default_branch}}
      - name: Build and push Trino image
        if: steps.build_flags.outputs.will_build_trino == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/services/trino/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta_trino.outputs.tags }}
          labels: ${{ steps.meta_trino.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Spark
      - name: Extract Spark metadata
        id: meta_spark
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/shugur-network/shudl/spark
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=dev-
            type=raw,value=latest,enable={{is_default_branch}}
      - name: Build and push Spark image
        if: steps.build_flags.outputs.will_build_spark == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          file: ./docker/services/spark/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta_spark.outputs.tags }}
          labels: ${{ steps.meta_spark.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      # Trivy scan for MinIO
      - name: Run Trivy vulnerability scanner for MinIO
        if: steps.build_flags.outputs.will_build_minio == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/shugur-network/shudl/minio:latest
          format: 'sarif'
          output: 'trivy-results-minio.sarif'
          severity: 'CRITICAL,HIGH'

      # Trivy scan for PostgreSQL
      - name: Run Trivy vulnerability scanner for PostgreSQL
        if: steps.build_flags.outputs.will_build_postgresql == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/shugur-network/shudl/postgresql:latest
          format: 'sarif'
          output: 'trivy-results-postgresql.sarif'
          severity: 'CRITICAL,HIGH'

      # Trivy scan for Patroni
      - name: Run Trivy vulnerability scanner for Patroni
        if: steps.build_flags.outputs.will_build_patroni == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/shugur-network/shudl/patroni:latest
          format: 'sarif'
          output: 'trivy-results-patroni.sarif'
          severity: 'CRITICAL,HIGH'

      # Trivy scan for Nessie
      - name: Run Trivy vulnerability scanner for Nessie
        if: steps.build_flags.outputs.will_build_nessie == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/shugur-network/shudl/nessie:latest
          format: 'sarif'
          output: 'trivy-results-nessie.sarif'
          severity: 'CRITICAL,HIGH'

      # Trivy scan for Trino
      - name: Run Trivy vulnerability scanner for Trino
        if: steps.build_flags.outputs.will_build_trino == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/shugur-network/shudl/trino:latest
          format: 'sarif'
          output: 'trivy-results-trino.sarif'
          severity: 'CRITICAL,HIGH'

      # Trivy scan for Spark
      - name: Run Trivy vulnerability scanner for Spark
        if: steps.build_flags.outputs.will_build_spark == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/shugur-network/shudl/spark:latest
          format: 'sarif'
          output: 'trivy-results-spark.sarif'
          severity: 'CRITICAL,HIGH'

      # Upload SARIF results as artifacts
      - name: Upload SARIF results as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: |
            trivy-results-minio.sarif
            trivy-results-postgresql.sarif
            trivy-results-patroni.sarif
            trivy-results-nessie.sarif
            trivy-results-trino.sarif
            trivy-results-spark.sarif

  build-lakectl:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build lakectl
        run: |
          cd installer/cmd/lakectl
          go build -o lakectl .

      - name: Upload lakectl artifact
        uses: actions/upload-artifact@v4
        with:
          name: lakectl
          path: installer/cmd/lakectl/lakectl
