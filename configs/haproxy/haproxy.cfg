global
    maxconn 1000
    log stdout format raw local0 info
    user haproxy
    group haproxy

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  1h
    timeout server  1h
    timeout check   5s

# PostgreSQL Write Traffic (Primary Only)
frontend postgres_write
    bind *:5000
    mode tcp
    default_backend postgres_primary

# PostgreSQL Read Traffic (All Nodes)
frontend postgres_read
    bind *:5001
    mode tcp
    default_backend postgres_replicas

# Backend: Primary Node Only (for writes)
backend postgres_primary
    mode tcp
    option httpchk GET /leader
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    
    # Only the node that responds 200 to /leader is active
    server patroni1 postgresql-patroni-1:5432 check port 8008
    server patroni2 postgresql-patroni-2:5432 check port 8008

# Backend: All Healthy Nodes (for reads)
backend postgres_replicas
    mode tcp
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    default-server inter 3s fall 3 rise 2
    
    # All healthy nodes (primary and replicas) can serve reads
    server patroni1 postgresql-patroni-1:5432 check port 8008
    server patroni2 postgresql-patroni-2:5432 check port 8008

# Statistics Dashboard
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node
    stats admin if TRUE
    
    # Show more details
    stats show-desc PostgreSQL HA via Patroni
    
    # Color coding
    option httpchk

