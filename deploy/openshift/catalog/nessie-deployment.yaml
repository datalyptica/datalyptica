---
# Nessie ConfigMap (application.properties)
apiVersion: v1
kind: ConfigMap
metadata:
  name: nessie-config
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: nessie
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: catalog
    datalyptica.io/component: nessie
data:
  application.properties: |
    # Server Configuration
    quarkus.http.port=19120
    quarkus.http.host=0.0.0.0
    quarkus.http.cors=true
    quarkus.http.cors.origins=*
    quarkus.http.cors.methods=GET,POST,PUT,DELETE,OPTIONS
    quarkus.http.cors.headers=accept,authorization,content-type,x-requested-with
    quarkus.http.cors.exposed-headers=Content-Disposition
    quarkus.http.cors.access-control-max-age=24H
    
    # JDBC Backend Configuration (PostgreSQL)
    nessie.version.store.type=JDBC
    quarkus.datasource.db-kind=postgresql
    quarkus.datasource.jdbc.url=jdbc:postgresql://datalyptica-postgres-primary.datalyptica.svc:5432/nessie
    quarkus.datasource.jdbc.initial-size=2
    quarkus.datasource.jdbc.min-size=2
    quarkus.datasource.jdbc.max-size=10
    
    # Catalog Configuration
    nessie.catalog.default-warehouse=warehouse
    nessie.catalog.warehouses.warehouse.location=s3://lakehouse/
    
    # S3/MinIO Configuration
    nessie.catalog.service.s3.default-options.endpoint=http://minio.datalyptica.svc.cluster.local:9000
    nessie.catalog.service.s3.default-options.auth-type=STATIC
    nessie.catalog.service.s3.default-options.access-key=urn:nessie-secret:quarkus:s3-default
    nessie.catalog.service.s3.default-options.path-style-access=true
    nessie.catalog.service.s3.default-options.region=us-east-1
    
    # Authentication (disabled for internal cluster access)
    nessie.server.authentication.enabled=false
    
    # Logging Configuration
    quarkus.log.level=INFO
    quarkus.log.category."org.projectnessie".level=INFO
    quarkus.log.console.enable=true
    quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n
---
# Nessie Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nessie
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: nessie
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: catalog
    datalyptica.io/component: nessie
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: nessie
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: nessie
        app.kubernetes.io/part-of: datalyptica
        datalyptica.io/tier: catalog
        datalyptica.io/component: nessie
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - nessie
              topologyKey: kubernetes.io/hostname
      containers:
      - name: nessie
        image: ghcr.io/projectnessie/nessie:0.77.1
        ports:
        - containerPort: 19120
          name: http
          protocol: TCP
        env:
        # PostgreSQL credentials (CrunchyData-generated secret)
        - name: QUARKUS_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: datalyptica-postgres-pguser-nessie
              key: user
        - name: QUARKUS_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: datalyptica-postgres-pguser-nessie
              key: password
        # MinIO credentials (using Quarkus secret URN notation)
        - name: QUARKUS_CONFIG_SECRET_S3_DEFAULT_NAME
          valueFrom:
            secretKeyRef:
              name: nessie-minio-credentials
              key: access-key
        - name: QUARKUS_CONFIG_SECRET_S3_DEFAULT_SECRET
          valueFrom:
            secretKeyRef:
              name: nessie-minio-credentials
              key: secret-key
        volumeMounts:
        - name: config
          mountPath: /deployments/config
          readOnly: true
        livenessProbe:
          httpGet:
            path: /q/health/live
            port: 19120
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /q/health/ready
            port: 19120
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: config
        configMap:
          name: nessie-config
---
# Nessie Service
apiVersion: v1
kind: Service
metadata:
  name: nessie
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: nessie
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: catalog
    datalyptica.io/component: nessie
spec:
  type: ClusterIP
  ports:
  - port: 19120
    targetPort: 19120
    protocol: TCP
    name: http
  selector:
    app.kubernetes.io/name: nessie
---
# Nessie Route (external access)
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: nessie
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: nessie
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: catalog
    datalyptica.io/component: nessie
spec:
  to:
    kind: Service
    name: nessie
  port:
    targetPort: http
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
---
# Nessie PodDisruptionBudget (ensure at least 2 replicas during maintenance)
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: nessie
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: nessie
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: catalog
    datalyptica.io/component: nessie
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: nessie
