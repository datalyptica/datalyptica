apiVersion: v1
kind: ConfigMap
metadata:
  name: jupyterhub-config
  namespace: datalyptica-management
  labels:
    app: jupyterhub
    layer: analytics
data:
  jupyterhub_config.py: |
    import os
    from jupyterhub.auth import DummyAuthenticator
    from kubespawner import KubeSpawner

    # Hub configuration
    c.JupyterHub.hub_ip = '0.0.0.0'
    c.JupyterHub.hub_port = 8081
    c.JupyterHub.port = 8000
    c.JupyterHub.base_url = '/'

    # Database
    c.JupyterHub.db_url = f"postgresql://{os.getenv('POSTGRES_USER')}:{os.getenv('POSTGRES_PASSWORD')}@{os.getenv('POSTGRES_HOST')}/{os.getenv('POSTGRES_DB')}"

    # Spawner configuration
    c.JupyterHub.spawner_class = KubeSpawner
    c.KubeSpawner.namespace = 'datalyptica-management'
    c.KubeSpawner.image = 'ghcr.io/datalyptica/datalyptica/jupyterlab:v1.0.0'
    c.KubeSpawner.image_pull_policy = 'IfNotPresent'

    # Resource limits for spawned notebooks
    c.KubeSpawner.cpu_guarantee = 0.5
    c.KubeSpawner.cpu_limit = 4.0
    c.KubeSpawner.mem_guarantee = '2G'
    c.KubeSpawner.mem_limit = '8G'

    # Storage
    c.KubeSpawner.storage_pvc_ensure = True
    c.KubeSpawner.storage_class = 'standard'
    c.KubeSpawner.storage_capacity = '10Gi'
    c.KubeSpawner.storage_access_modes = ['ReadWriteOnce']
    c.KubeSpawner.pvc_name_template = 'jupyter-{username}'

    # Volumes
    c.KubeSpawner.volumes = [
        {
            'name': 'data',
            'persistentVolumeClaim': {
                'claimName': 'jupyter-{username}'
            }
        }
    ]
    c.KubeSpawner.volume_mounts = [
        {
            'name': 'data',
            'mountPath': '/home/jovyan'
        }
    ]

    # Environment variables for spawned notebooks
    c.KubeSpawner.environment = {
        'JUPYTER_ENABLE_LAB': 'yes',
        'GRANT_SUDO': 'no',
        'TRINO_HOST': 'trino.datalyptica-data.svc.cluster.local',
        'TRINO_PORT': '8080',
        'SPARK_MASTER': 'spark://spark-master.datalyptica-data.svc.cluster.local:7077',
        'MINIO_ENDPOINT': 'minio.datalyptica-storage.svc.cluster.local:9000',
    }

    # Service account
    c.KubeSpawner.service_account = 'jupyterhub'

    # Networking
    c.KubeSpawner.port = 8888
    c.KubeSpawner.http_timeout = 120
    c.KubeSpawner.start_timeout = 300

    # Culling
    c.JupyterHub.services = [
        {
            'name': 'idle-culler',
            'admin': True,
            'command': [
                'python3', '-m', 'jupyterhub_idle_culler',
                '--timeout=3600',  # 1 hour
                '--cull-every=600',  # Check every 10 minutes
                '--concurrency=10',
                '--max-age=0',
            ],
        }
    ]

    # Authentication (use DummyAuthenticator for demo, integrate with Keycloak in production)
    c.JupyterHub.authenticator_class = DummyAuthenticator
    c.DummyAuthenticator.password = os.getenv('JUPYTERHUB_PASSWORD', 'jupyter')

    # Admin users
    c.Authenticator.admin_users = {'admin', 'jupyter'}
    c.Authenticator.allowed_users = {'*'}

    # Security
    c.JupyterHub.cookie_secret_file = '/srv/jupyterhub/cookie_secret'
    c.ConfigurableHTTPProxy.auth_token = os.getenv('CONFIGPROXY_AUTH_TOKEN')

    # Logging
    c.JupyterHub.log_level = 'INFO'
    c.Spawner.debug = False
