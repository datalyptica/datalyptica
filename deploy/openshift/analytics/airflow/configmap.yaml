apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-config
  namespace: datalyptica-management
  labels:
    app: airflow
    layer: analytics
data:
  AIRFLOW__CORE__EXECUTOR: CeleryExecutor
  AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags
  AIRFLOW__CORE__BASE_LOG_FOLDER: /opt/airflow/logs
  AIRFLOW__CORE__LOAD_EXAMPLES: "False"
  AIRFLOW__CORE__LOAD_DEFAULT_CONNECTIONS: "False"

  # Database
  AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:${POSTGRES_PASSWORD}@postgresql.datalyptica-storage.svc.cluster.local:5432/airflow
  AIRFLOW__DATABASE__SQL_ALCHEMY_POOL_SIZE: "10"
  AIRFLOW__DATABASE__SQL_ALCHEMY_POOL_RECYCLE: "3600"
  AIRFLOW__DATABASE__SQL_ALCHEMY_MAX_OVERFLOW: "20"

  # Celery
  AIRFLOW__CELERY__BROKER_URL: redis://:${REDIS_PASSWORD}@redis.datalyptica-infrastructure.svc.cluster.local:6379/0
  AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:${POSTGRES_PASSWORD}@postgresql.datalyptica-storage.svc.cluster.local:5432/airflow
  AIRFLOW__CELERY__WORKER_CONCURRENCY: "16"
  AIRFLOW__CELERY__WORKER_PREFETCH_MULTIPLIER: "4"
  AIRFLOW__CELERY__TASK_ACKS_LATE: "True"

  # Webserver
  AIRFLOW__WEBSERVER__BASE_URL: http://airflow-webserver:8080
  AIRFLOW__WEBSERVER__WEB_SERVER_PORT: "8080"
  AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "False"
  AIRFLOW__WEBSERVER__RBAC: "True"
  AIRFLOW__WEBSERVER__RELOAD_ON_PLUGIN_CHANGE: "False"

  # Scheduler
  AIRFLOW__SCHEDULER__SCHEDULER_HEARTBEAT_SEC: "5"
  AIRFLOW__SCHEDULER__MIN_FILE_PROCESS_INTERVAL: "30"
  AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL: "300"
  AIRFLOW__SCHEDULER__PARSING_PROCESSES: "2"
  AIRFLOW__SCHEDULER__SCHEDULER_HEALTH_CHECK_THRESHOLD: "30"

  # Logging
  AIRFLOW__LOGGING__LOGGING_LEVEL: INFO
  AIRFLOW__LOGGING__COLORED_CONSOLE_LOG: "False"
  AIRFLOW__LOGGING__LOG_FORMAT: "[%%(asctime)s] {%%(filename)s:%%(lineno)d} %%(levelname)s - %%(message)s"
  AIRFLOW__LOGGING__SIMPLE_LOG_FORMAT: "%%(asctime)s %%(levelname)s - %%(message)s"

  # Metrics
  AIRFLOW__METRICS__STATSD_ON: "False"

  # API
  AIRFLOW__API__AUTH_BACKENDS: airflow.api.auth.backend.basic_auth

  # Email (configure if needed)
  AIRFLOW__EMAIL__EMAIL_BACKEND: airflow.utils.email.send_email_smtp
  AIRFLOW__SMTP__SMTP_HOST: localhost
  AIRFLOW__SMTP__SMTP_PORT: "25"
  AIRFLOW__SMTP__SMTP_STARTTLS: "False"
  AIRFLOW__SMTP__SMTP_SSL: "False"

  # Kubernetes executor (for future use)
  AIRFLOW__KUBERNETES__NAMESPACE: datalyptica-management
  AIRFLOW__KUBERNETES__WORKER_CONTAINER_REPOSITORY: ghcr.io/datalyptica/datalyptica/airflow
  AIRFLOW__KUBERNETES__WORKER_CONTAINER_TAG: v1.0.0
  AIRFLOW__KUBERNETES__DELETE_WORKER_PODS: "True"
  AIRFLOW__KUBERNETES__DELETE_WORKER_PODS_ON_FAILURE: "False"
