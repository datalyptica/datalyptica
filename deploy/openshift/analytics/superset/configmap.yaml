apiVersion: v1
kind: ConfigMap
metadata:
  name: superset-config
  namespace: datalyptica-management
  labels:
    app: superset
    layer: analytics
data:
  # Flask config
  FLASK_APP: superset
  SUPERSET_ENV: production

  # Database
  DATABASE_DIALECT: postgresql
  DATABASE_HOST: postgresql.datalyptica-storage.svc.cluster.local
  DATABASE_PORT: "5432"
  DATABASE_DB: superset
  DATABASE_USER: superset

  # Redis cache
  REDIS_HOST: redis.datalyptica-infrastructure.svc.cluster.local
  REDIS_PORT: "6379"

  # Superset config
  SUPERSET_WEBSERVER_PORT: "8088"
  SUPERSET_WEBSERVER_TIMEOUT: "300"
  SUPERSET_LOAD_EXAMPLES: "no"

  # Feature flags
  FEATURE_FLAGS: |
    {
      "DASHBOARD_NATIVE_FILTERS": true,
      "ENABLE_TEMPLATE_PROCESSING": true,
      "DASHBOARD_CROSS_FILTERS": true,
      "DASHBOARD_RBAC": true
    }

  superset_config.py: |
    import os
    from cachelib.redis import RedisCache

    # Database
    SQLALCHEMY_DATABASE_URI = f"postgresql://{os.getenv('DATABASE_USER')}:{os.getenv('DATABASE_PASSWORD')}@{os.getenv('DATABASE_HOST')}:{os.getenv('DATABASE_PORT')}/{os.getenv('DATABASE_DB')}"
    SQLALCHEMY_TRACK_MODIFICATIONS = False

    # Redis cache
    CACHE_CONFIG = {
        'CACHE_TYPE': 'RedisCache',
        'CACHE_DEFAULT_TIMEOUT': 300,
        'CACHE_KEY_PREFIX': 'superset_',
        'CACHE_REDIS_HOST': os.getenv('REDIS_HOST'),
        'CACHE_REDIS_PORT': int(os.getenv('REDIS_PORT')),
        'CACHE_REDIS_PASSWORD': os.getenv('REDIS_PASSWORD'),
        'CACHE_REDIS_DB': 1,
    }

    # Celery config for async queries
    class CeleryConfig:
        broker_url = f"redis://:{os.getenv('REDIS_PASSWORD')}@{os.getenv('REDIS_HOST')}:{os.getenv('REDIS_PORT')}/2"
        result_backend = f"redis://:{os.getenv('REDIS_PASSWORD')}@{os.getenv('REDIS_HOST')}:{os.getenv('REDIS_PORT')}/3"
        worker_prefetch_multiplier = 10
        task_acks_late = True

    CELERY_CONFIG = CeleryConfig

    # Security
    SECRET_KEY = os.getenv('SECRET_KEY', 'changeme')
    WTF_CSRF_ENABLED = True
    WTF_CSRF_EXEMPT_LIST = []
    WTF_CSRF_TIME_LIMIT = None

    # Flask-WTF flag for CSRF
    WTF_CSRF_METHODS = ['POST', 'PUT', 'PATCH', 'DELETE']

    # Session config
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SECURE = False  # Set to True if using HTTPS
    SESSION_COOKIE_SAMESITE = 'Lax'

    # Enable/disable features
    FEATURE_FLAGS = {
        "DASHBOARD_NATIVE_FILTERS": True,
        "ENABLE_TEMPLATE_PROCESSING": True,
        "DASHBOARD_CROSS_FILTERS": True,
        "DASHBOARD_RBAC": True,
    }

    # Row limit
    ROW_LIMIT = 50000
    SQL_MAX_ROW = 100000

    # Webserver
    SUPERSET_WEBSERVER_PROTOCOL = 'http'
    SUPERSET_WEBSERVER_ADDRESS = '0.0.0.0'
    SUPERSET_WEBSERVER_PORT = 8088

    # CORS
    ENABLE_CORS = True
    CORS_OPTIONS = {
        'supports_credentials': True,
        'allow_headers': ['*'],
        'resources': ['*'],
        'origins': ['*']
    }

    # Mapbox API key (optional)
    MAPBOX_API_KEY = os.getenv('MAPBOX_API_KEY', '')
