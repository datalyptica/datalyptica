apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-management-scraping
  namespace: datalyptica-storage
  labels:
    layer: security
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus scraping from management namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090 # Metrics endpoints
        - protocol: TCP
          port: 9100
        - protocol: TCP
          port: 9187
        - protocol: TCP
          port: 9363
    # Allow Loki log collection from management namespace
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: alloy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-management-scraping
  namespace: datalyptica-control
  labels:
    layer: security
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 9100
        - protocol: TCP
          port: 7071 # Kafka JMX
    # Allow Loki log collection
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: alloy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-management-scraping
  namespace: datalyptica-data
  labels:
    layer: security
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 9100
        - protocol: TCP
          port: 9249 # Flink metrics
        - protocol: TCP
          port: 9363 # ClickHouse metrics
    # Allow Loki log collection
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: alloy
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-management-scraping
  namespace: datalyptica-infrastructure
  labels:
    layer: security
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    # Allow Prometheus scraping
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: prometheus
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 9100
    # Allow Loki log collection
    - from:
        - namespaceSelector:
            matchLabels:
              name: datalyptica-management
        - podSelector:
            matchLabels:
              app: alloy
