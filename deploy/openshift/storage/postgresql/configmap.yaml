---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-patroni-config
  namespace: datalyptica-storage
  labels:
    app: postgresql
data:
  patroni.yml: |
    scope: postgresql-ha
    namespace: datalyptica-storage
    name: ${PATRONI_NAME}

    restapi:
      listen: 0.0.0.0:8008
      connect_address: ${POD_IP}:8008

    kubernetes:
      namespace: datalyptica-storage
      labels:
        app: postgresql
        cluster-name: postgresql-ha
      scope_label: cluster-name
      role_label: role
      use_endpoints: true

    bootstrap:
      dcs:
        ttl: 30
        loop_wait: 10
        retry_timeout: 10
        maximum_lag_on_failover: 1048576
        postgresql:
          use_pg_rewind: true
          use_slots: true
          parameters:
            max_connections: 200
            shared_buffers: 256MB
            effective_cache_size: 1GB
            maintenance_work_mem: 64MB
            checkpoint_completion_target: 0.9
            wal_buffers: 16MB
            default_statistics_target: 100
            random_page_cost: 1.1
            effective_io_concurrency: 200
            work_mem: 5MB
            min_wal_size: 1GB
            max_wal_size: 4GB
            max_worker_processes: 4
            max_parallel_workers_per_gather: 2
            max_parallel_workers: 4
            max_parallel_maintenance_workers: 2
            wal_level: replica
            hot_standby: on
            max_wal_senders: 10
            max_replication_slots: 10
            hot_standby_feedback: on
            wal_keep_size: 1GB
            wal_log_hints: on
            log_destination: stderr
            logging_collector: on
            log_directory: log
            log_filename: postgresql-%Y-%m-%d_%H%M%S.log
            log_rotation_age: 1d
            log_rotation_size: 100MB
            log_min_duration_statement: 1000
            log_line_prefix: '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
            log_checkpoints: on
            log_connections: on
            log_disconnections: on
            log_lock_waits: on

      initdb:
        - encoding: UTF8
        - data-checksums

      pg_hba:
        - host replication replicator 0.0.0.0/0 md5
        - host all all 0.0.0.0/0 md5
        - local all all trust

      users:
        admin:
          password: ${PATRONI_admin_PASSWORD}
          options:
            - createrole
            - createdb

    postgresql:
      listen: 0.0.0.0:5432
      connect_address: ${POD_IP}:5432
      data_dir: /var/lib/postgresql/data/pgdata
      pgpass: /tmp/.pgpass
      authentication:
        replication:
          username: replicator
          password: ${PATRONI_REPLICATION_PASSWORD}
        superuser:
          username: postgres
          password: ${PATRONI_SUPERUSER_PASSWORD}
      parameters:
        unix_socket_directories: /var/run/postgresql
      create_replica_methods:
        - basebackup
      basebackup:
        checkpoint: fast
        max-rate: 100M

    watchdog:
      mode: off

    tags:
      nofailover: false
      noloadbalance: false
      clonefrom: false
      nosync: false
    log_temp_files = 0

  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            trust
    host    all             all             ::1/128                 trust
    host    all             all             0.0.0.0/0               md5
    host    replication     replicator      0.0.0.0/0               md5
