---
# MinIO Bucket Initialization Job
# Creates required buckets and sets policies after MinIO cluster is running
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init-buckets
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: storage
    datalyptica.io/component: minio-init
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minio-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: create-buckets
        image: quay.io/minio/mc:latest
        command:
        - /bin/sh
        - -c
        - |
          #!/bin/sh
          set -e
          
          echo "========================================"
          echo "MinIO Bucket Initialization"
          echo "========================================"
          
          echo "Waiting for MinIO to be ready..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          
          until mc alias set myminio http://minio.datalyptica.svc.cluster.local:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} 2>/dev/null; do
            RETRY_COUNT=$((RETRY_COUNT+1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "ERROR: MinIO failed to become ready after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "Attempt $RETRY_COUNT/$MAX_RETRIES: MinIO not ready yet, waiting 10 seconds..."
            sleep 10
          done
          
          echo "✓ MinIO is ready!"
          echo ""
          
          echo "Creating buckets..."
          
          # Create buckets if they don't exist
          mc mb --ignore-existing myminio/datalyptica
          echo "✓ Bucket 'datalyptica' created (general platform data)"
          
          mc mb --ignore-existing myminio/lakehouse
          echo "✓ Bucket 'lakehouse' created (Iceberg table data)"
          
          mc mb --ignore-existing myminio/warehouse
          echo "✓ Bucket 'warehouse' created (Nessie warehouse location)"
          
          mc mb --ignore-existing myminio/mlflow
          echo "✓ Bucket 'mlflow' created (MLflow artifacts)"
          
          mc mb --ignore-existing myminio/airflow
          echo "✓ Bucket 'airflow' created (Airflow logs and XComs)"
          
          echo ""
          echo "Setting bucket policies..."
          
          # Set anonymous download policy for lakehouse and warehouse
          mc anonymous set download myminio/lakehouse 2>/dev/null || echo "Note: Policy already set for lakehouse"
          echo "✓ Policy set for 'lakehouse' (public download)"
          
          mc anonymous set download myminio/warehouse 2>/dev/null || echo "Note: Policy already set for warehouse"
          echo "✓ Policy set for 'warehouse' (public download)"
          
          echo ""
          echo "Bucket Summary:"
          mc ls myminio
          
          echo ""
          echo "========================================"
          echo "✓ Bucket initialization complete!"
          echo "========================================"
        env:
        - name: MC_CONFIG_DIR
          value: "/tmp/.mc"
        - name: MINIO_ROOT_USER
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-user
        - name: MINIO_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-password
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
