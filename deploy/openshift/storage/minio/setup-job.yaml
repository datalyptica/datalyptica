---
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: datalyptica-storage
  labels:
    app: minio
    component: setup
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: minio
        component: setup
    spec:
      restartPolicy: OnFailure
      containers:
        - name: mc
          image: minio/mc:latest
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for MinIO to be ready..."
              until mc alias set myminio http://minio.datalyptica-storage.svc.cluster.local:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do
                echo "Waiting for MinIO..."
                sleep 5
              done

              echo "Creating buckets..."
              mc mb -p myminio/warehouse || true
              mc mb -p myminio/lakehouse || true
              mc mb -p myminio/data || true
              mc mb -p myminio/temp || true
              mc mb -p myminio/logs || true
              mc mb -p myminio/backups || true

              echo "Setting versioning..."
              mc version enable myminio/warehouse
              mc version enable myminio/lakehouse

              echo "Setting lifecycle policies..."
              cat <<EOF > /tmp/lifecycle.json
              {
                "Rules": [
                  {
                    "ID": "DeleteTemp",
                    "Status": "Enabled",
                    "Filter": {"Prefix": ""},
                    "Expiration": {"Days": 7}
                  }
                ]
              }
              EOF
              mc ilm import myminio/temp < /tmp/lifecycle.json || true

              echo "Creating access keys..."
              mc admin user add myminio datalyptica ${DATALYPTICA_PASSWORD} || true
              mc admin policy attach myminio readwrite --user datalyptica

              echo "MinIO setup completed successfully"
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: root_user
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: root_password
            - name: DATALYPTICA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: datalyptica_password
