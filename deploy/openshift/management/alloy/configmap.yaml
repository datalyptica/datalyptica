apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: datalyptica-management
  labels:
    app: alloy
data:
  config.alloy: |
    logging {
      level  = "info"
      format = "logfmt"
    }

    // Discover Kubernetes pods
    discovery.kubernetes "pods" {
      role = "pod"
    }

    // Relabel pod logs
    discovery.relabel "pod_logs" {
      targets = discovery.kubernetes.pods.targets
      
      // Only scrape pods with annotations
      rule {
        source_labels = ["__meta_kubernetes_pod_annotation_prometheus_io_scrape"]
        action        = "keep"
        regex         = "true"
      }
      
      // Extract namespace
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }
      
      // Extract pod name
      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }
      
      // Extract container name
      rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        target_label  = "container"
      }
      
      // Extract node name
      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }
      
      // Set log path
      rule {
        source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_name", "__meta_kubernetes_pod_container_name"]
        target_label  = "__path__"
        separator     = "/"
        replacement   = "/var/log/pods/$1_$2_*/$$3/*.log"
      }
    }

    // Scrape container logs
    loki.source.kubernetes "pods" {
      targets    = discovery.relabel.pod_logs.output
      forward_to = [loki.process.pod_logs.receiver]
    }

    // Process logs
    loki.process "pod_logs" {
      // Parse JSON logs
      stage.json {
        expressions = {
          level     = "level",
          timestamp = "timestamp",
          message   = "message",
        }
      }
      
      // Extract log level
      stage.labels {
        values = {
          level = "",
        }
      }
      
      // Drop debug logs in production
      stage.match {
        selector = "{level=\"debug\"}"
        action   = "drop"
      }
      
      forward_to = [loki.write.default.receiver]
    }

    // Write to Loki
    loki.write "default" {
      endpoint {
        url = env("LOKI_URL")
        
        // Retry settings
        max_retries   = 10
        min_backoff   = "500ms"
        max_backoff   = "5s"
      }
      
      // Batching settings
      external_labels = {
        cluster = "datalyptica-production",
        env     = "production",
      }
    }

    // Scrape host logs
    loki.source.file "system_logs" {
      targets = [
        {
          __path__ = "/var/log/syslog",
          job      = "syslog",
          host     = env("HOSTNAME"),
        },
        {
          __path__ = "/var/log/messages",
          job      = "messages",
          host     = env("HOSTNAME"),
        },
      ]
      
      forward_to = [loki.write.default.receiver]
    }
