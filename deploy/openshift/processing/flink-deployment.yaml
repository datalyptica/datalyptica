---
# Flink ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-config
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
    datalyptica.io/component: flink
data:
  flink-conf.yaml: |
    # JobManager Configuration (no fixed RPC address in HA mode)
    jobmanager.rpc.port: 6123
    jobmanager.memory.process.size: 2048m
    jobmanager.memory.jvm-overhead.max: 512m
    
    # High Availability Configuration
    high-availability.type: kubernetes
    high-availability.storageDir: file:///opt/flink/ha
    high-availability.cluster-id: datalyptica-flink
    kubernetes.cluster-id: datalyptica-flink
    kubernetes.namespace: datalyptica
    
    # TaskManager Configuration
    taskmanager.memory.process.size: 2048m
    taskmanager.memory.managed.fraction: 0.4
    taskmanager.numberOfTaskSlots: 4
    
    # State Backend Configuration (Iceberg)
    state.backend: rocksdb
    state.checkpoints.dir: file:///opt/flink/checkpoints
    state.savepoints.dir: file:///opt/flink/savepoints
    state.backend.incremental: true
    
    # Execution Configuration
    execution.checkpointing.interval: 30s
    execution.checkpointing.mode: EXACTLY_ONCE
    execution.checkpointing.min-pause: 10s
    execution.checkpointing.max-concurrent-checkpoints: 1
    execution.checkpointing.timeout: 10min
    execution.checkpointing.tolerable-failed-checkpoints: 3
    
    # REST API Configuration
    rest.port: 8081
    rest.address: flink-jobmanager
    
    # Web UI Configuration
    web.submit.enable: true
    web.cancel.enable: true
    web.checkpoints.history: 10
    
    # Restart Strategy
    restart-strategy: fixed-delay
    restart-strategy.fixed-delay.attempts: 3
    restart-strategy.fixed-delay.delay: 10s
    
    # Metrics Configuration
    metrics.reporters: prom
    metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
    metrics.reporter.prom.port: 9249
    
    # S3 Configuration
    s3.endpoint: http://minio.datalyptica.svc.cluster.local:9000
    s3.path.style.access: true
    
    # Table Configuration
    table.exec.resource.default-parallelism: 4
    
  log4j-console.properties: |
    rootLogger.level = INFO
    rootLogger.appenderRef.console.ref = ConsoleAppender
    
    appender.console.name = ConsoleAppender
    appender.console.type = CONSOLE
    appender.console.layout.type = PatternLayout
    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
    
    logger.akka.name = akka
    logger.akka.level = INFO
    
    logger.kafka.name= org.apache.kafka
    logger.kafka.level = INFO
    
    logger.hadoop.name = org.apache.hadoop
    logger.hadoop.level = INFO
    
    logger.zookeeper.name = org.apache.zookeeper
    logger.zookeeper.level = INFO
---
# Flink SQL ConfigMap (Iceberg Catalog)
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-sql-config
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
    datalyptica.io/component: flink
data:
  sql-client-defaults.yaml: |
    catalogs:
      - name: iceberg
        type: iceberg
        catalog-type: nessie
        uri: http://nessie.datalyptica.svc.cluster.local:19120/api/v2
        ref: main
        warehouse: s3://lakehouse/
        io-impl: org.apache.iceberg.aws.s3.S3FileIO
        s3.endpoint: http://minio.datalyptica.svc.cluster.local:9000
        s3.path-style-access: true
    
    execution:
      planner: blink
      type: streaming
      time-characteristic: event-time
      periodic-watermarks-interval: 200
      result-mode: table
      max-table-result-rows: 1000000
      parallelism: 4
      max-parallelism: 128
      min-idle-state-retention: 0
      max-idle-state-retention: 0
---
# Flink JobManager Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-jobmanager
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
    datalyptica.io/component: flink-jobmanager
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: flink
      app.kubernetes.io/component: jobmanager
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: flink
        app.kubernetes.io/part-of: datalyptica
        datalyptica.io/tier: streaming
        app.kubernetes.io/component: jobmanager
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - taskmanager
              topologyKey: kubernetes.io/hostname
      serviceAccountName: flink
      containers:
      - name: jobmanager
        image: image-registry.openshift-image-registry.svc:5000/datalyptica/flink-connectors:2.1.0
        args: ["jobmanager"]
        ports:
        - containerPort: 6123
          name: rpc
          protocol: TCP
        - containerPort: 6124
          name: blob
          protocol: TCP
        - containerPort: 8081
          name: webui
          protocol: TCP
        - containerPort: 9249
          name: metrics
          protocol: TCP
        env:
        - name: FLINK_PROPERTIES
          value: |
            jobmanager.rpc.address: flink-jobmanager
            kubernetes.cluster-id: datalyptica-flink
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-user
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-password
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-user
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-password
        volumeMounts:
        - name: flink-config
          mountPath: /opt/flink/conf/flink-conf.yaml
          subPath: flink-conf.yaml
        - name: flink-config
          mountPath: /opt/flink/conf/log4j-console.properties
          subPath: log4j-console.properties
        - name: flink-sql-config
          mountPath: /opt/flink/conf/sql-client-defaults.yaml
          subPath: sql-client-defaults.yaml
        livenessProbe:
          httpGet:
            path: /overview
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /overview
            port: 8081
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "3Gi"
            cpu: "2000m"
      volumes:
      - name: flink-config
        configMap:
          name: flink-config
      - name: flink-sql-config
        configMap:
          name: flink-sql-config
---
# Flink TaskManager Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-taskmanager
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
    datalyptica.io/component: flink-taskmanager
spec:
  replicas: 5
  selector:
    matchLabels:
      app.kubernetes.io/name: flink
      app.kubernetes.io/component: taskmanager
  template:
    metadata:
      labels:
        app.kubernetes.io/name: flink
        app.kubernetes.io/part-of: datalyptica
        datalyptica.io/tier: streaming
        app.kubernetes.io/component: taskmanager
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - taskmanager
              topologyKey: kubernetes.io/hostname
      serviceAccountName: flink
      containers:
      - name: taskmanager
        image: image-registry.openshift-image-registry.svc:5000/datalyptica/flink-connectors:2.1.0
        args: ["taskmanager"]
        ports:
        - containerPort: 6122
          name: rpc
          protocol: TCP
        - containerPort: 9249
          name: metrics
          protocol: TCP
        env:
        - name: FLINK_PROPERTIES
          value: |
            jobmanager.rpc.address: flink-jobmanager
            taskmanager.numberOfTaskSlots: 4
            kubernetes.cluster-id: datalyptica-flink
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-user
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-password
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-user
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: root-password
        volumeMounts:
        - name: flink-config
          mountPath: /opt/flink/conf/flink-conf.yaml
          subPath: flink-conf.yaml
        - name: flink-config
          mountPath: /opt/flink/conf/log4j-console.properties
          subPath: log4j-console.properties
        - name: flink-sql-config
          mountPath: /opt/flink/conf/sql-client-defaults.yaml
          subPath: sql-client-defaults.yaml
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "ps aux | grep -v grep | grep taskmanager"
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 5
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - "ps aux | grep -v grep | grep taskmanager"
          initialDelaySeconds: 20
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 5
        resources:
          requests:
            memory: "2Gi"
            cpu: "2000m"
          limits:
            memory: "3Gi"
            cpu: "4000m"
      volumes:
      - name: flink-config
        configMap:
          name: flink-config
      - name: flink-sql-config
        configMap:
          name: flink-sql-config
---
# Flink ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flink
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
---
# Flink Role (for HA)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: flink
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
# Flink RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: flink
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: flink
subjects:
- kind: ServiceAccount
  name: flink
  namespace: datalyptica
---
# Flink JobManager Service
apiVersion: v1
kind: Service
metadata:
  name: flink-jobmanager
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
    datalyptica.io/component: flink-jobmanager
spec:
  type: ClusterIP
  ports:
  - port: 6123
    targetPort: 6123
    protocol: TCP
    name: rpc
  - port: 6124
    targetPort: 6124
    protocol: TCP
    name: blob
  - port: 8081
    targetPort: 8081
    protocol: TCP
    name: webui
  - port: 9249
    targetPort: 9249
    protocol: TCP
    name: metrics
  selector:
    app.kubernetes.io/name: flink
    app.kubernetes.io/component: jobmanager
---
# Flink JobManager Route (WebUI)
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: flink-jobmanager
  namespace: datalyptica
  labels:
    app.kubernetes.io/name: flink
    app.kubernetes.io/part-of: datalyptica
    datalyptica.io/tier: streaming
    datalyptica.io/component: flink-jobmanager
spec:
  to:
    kind: Service
    name: flink-jobmanager
  port:
    targetPort: webui
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
